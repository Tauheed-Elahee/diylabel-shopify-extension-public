{% comment %}
  DIY Label Product Block - Optimized
{% endcomment %}

<div class="diy-label-product-block" 
     style="margin: {{ block.settings.margin }}px 0; 
            padding: {{ block.settings.padding }}px;
            {% if block.settings.background_color != blank %}background-color: {{ block.settings.background_color }};{% endif %}
            {% if block.settings.border_radius > 0 %}border-radius: {{ block.settings.border_radius }}px;{% endif %}
            {% if block.settings.show_border %}border: 1px solid {{ block.settings.border_color | default: '#e1e1e1' }};{% endif %}">
  
  {% if block.settings.show_title %}
    <h3 style="margin: 0 0 16px 0; 
               color: {{ block.settings.title_color }};
               font-size: {{ block.settings.title_size }}px;
               text-align: {{ block.settings.title_alignment }};">
      {{ block.settings.title | default: "ðŸŒ± Choose Local Printing" }}
    </h3>
  {% endif %}
  
  {% if block.settings.show_description %}
    <p style="margin: 0 0 20px 0; 
              color: {{ block.settings.description_color }};
              text-align: {{ block.settings.description_alignment }};">
      {{ block.settings.description | default: "Support your local community and reduce shipping impact by printing this item at a nearby shop." }}
    </p>
  {% endif %}
  
  <div id="diy-label-product-block-{{ block.id }}">
    <button 
      id="diy-label-btn-{{ block.id }}"
      data-product-id="{% if product %}{{ product.id }}{% endif %}"
      data-shop-domain="{{ shop.permanent_domain }}"
      data-theme="{{ block.settings.theme }}"
      data-api-url="{% if block.settings.api_url != blank %}{{ block.settings.api_url }}{% else %}https://increasing-exercise-calculation-yo.trycloudflare.com{% endif %}"
      style="width: 100%; 
             padding: 12px 24px; 
             background: #007cba; 
             color: white; 
             border: none; 
             border-radius: 6px; 
             font-size: 16px; 
             font-weight: 600; 
             cursor: pointer;
             transition: background-color 0.2s ease;">
      ðŸŒ± Choose Local Print Shop
    </button>
  </div>
</div>

<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

<script>
(function() {
  const blockId = '{{ block.id }}';
  const button = document.getElementById('diy-label-btn-' + blockId);
  
  if (!button) return;
  
  const productId = button.getAttribute('data-product-id');
  const shopDomain = button.getAttribute('data-shop-domain');
  const theme = button.getAttribute('data-theme');
  const apiUrl = button.getAttribute('data-api-url');
  
  if (!productId) {
    button.style.display = 'none';
    return;
  }
  
  button.addEventListener('mouseenter', function() {
    this.style.backgroundColor = '#005a8b';
  });
  
  button.addEventListener('mouseleave', function() {
    this.style.backgroundColor = '#007cba';
  });
  
  async function checkProductEnabled() {
    try {
      const response = await fetch(
        apiUrl + '/api/product-settings?shop=' + 
        encodeURIComponent(shopDomain) + 
        '&product=' + encodeURIComponent(productId)
      );
      
      if (!response.ok) return false;
      const data = await response.json();
      return data.enabled || false;
    } catch (error) {
      return false;
    }
  }
  
  function openDIYLabelModal() {
    if (document.getElementById('diy-label-modal-' + blockId)) {
      document.getElementById('diy-label-modal-' + blockId).style.display = 'flex';
      return;
    }
    
    const modal = document.createElement('div');
    modal.id = 'diy-label-modal-' + blockId;
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      box-sizing: border-box;
    `;
    
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
      background: white;
      border-radius: 12px;
      width: 100%;
      max-width: 900px;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      position: relative;
      display: flex;
      flex-direction: column;
    `;
    
    const modalHeader = document.createElement('div');
    modalHeader.style.cssText = `
      padding: 20px 24px;
      border-bottom: 1px solid #e1e1e1;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f8f9fa;
    `;
    
    const modalTitle = document.createElement('h2');
    modalTitle.style.cssText = 'margin: 0; font-size: 20px; font-weight: 600; color: #333333;';
    modalTitle.textContent = 'ðŸŒ± Choose Local Print Shop';
    
    const closeButton = document.createElement('button');
    closeButton.style.cssText = `
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666666;
      padding: 4px;
      border-radius: 4px;
    `;
    closeButton.innerHTML = 'Ã—';
    closeButton.addEventListener('click', function() {
      modal.style.display = 'none';
    });
    
    modalHeader.appendChild(modalTitle);
    modalHeader.appendChild(closeButton);
    
    const modalBody = document.createElement('div');
    modalBody.style.cssText = 'flex: 1; overflow-y: auto; padding: 0;';
    
    const iframe = document.createElement('iframe');
    iframe.src = apiUrl + '/widget?' + 
      'shop=' + encodeURIComponent(shopDomain) + 
      '&product=' + encodeURIComponent(productId) + 
      '&theme=' + encodeURIComponent(theme);
    
    iframe.style.cssText = 'width: 100%; height: 600px; border: none; background: white;';
    iframe.frameBorder = '0';
    iframe.loading = 'lazy';
    
    window.addEventListener('message', function(event) {
      if (event.origin !== apiUrl) return;
      
      if (event.data.type === 'diy-label-resize') {
        iframe.style.height = Math.max(600, event.data.height) + 'px';
      }
      
      if (event.data.type === 'diy-label-selection') {
        const printShop = event.data.printShop;
        
        // Update cart attributes
        updateCartAttributes(printShop);
        
        // Close modal
        modal.style.display = 'none';
      }
    });
    
    modalBody.appendChild(iframe);
    modalContent.appendChild(modalHeader);
    modalContent.appendChild(modalBody);
    modal.appendChild(modalContent);
    
    document.body.appendChild(modal);
    
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    });
  }
  
  async function updateCartAttributes(printShop) {
    try {
      const cartData = {
        attributes: {
          'diy_label_enabled': 'true',
          'diy_label_print_shop_id': printShop.id.toString(),
          'diy_label_print_shop_name': printShop.name,
          'diy_label_print_shop_address': printShop.address
        }
      };
      
      const response = await fetch('/cart/update.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(cartData)
      });
      
      if (response.ok) {
        alert('Print shop selected: ' + printShop.name + '\\n\\nYour order will be printed locally!');
      }
    } catch (error) {
      console.error('Error updating cart:', error);
    }
  }
  
  async function initializeButton() {
    const isEnabled = await checkProductEnabled();
    if (!isEnabled) {
      button.style.display = 'none';
      return;
    }
    
    button.addEventListener('click', openDIYLabelModal);
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeButton);
  } else {
    initializeButton();
  }
  
})();
</script>

{% schema %}
{
  "name": "DIY Label Product Widget",
  "target": "section",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_title",
      "label": "Show Title",
      "default": true
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "ðŸŒ± Choose Local Printing"
    },
    {
      "type": "range",
      "id": "title_size",
      "label": "Title Size",
      "min": 14,
      "max": 32,
      "step": 2,
      "default": 20
    },
    {
      "type": "select",
      "id": "title_alignment",
      "label": "Title Alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "left"
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Title Color",
      "default": "#333333"
    },
    {
      "type": "checkbox",
      "id": "show_description",
      "label": "Show Description",
      "default": true
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description",
      "default": "Support your local community and reduce shipping impact by printing this item at a nearby shop."
    },
    {
      "type": "select",
      "id": "description_alignment",
      "label": "Description Alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "left"
    },
    {
      "type": "color",
      "id": "description_color",
      "label": "Description Color",
      "default": "#666666"
    },
    {
      "type": "select",
      "id": "theme",
      "label": "Widget Theme",
      "options": [
        { "value": "light", "label": "Light" },
        { "value": "dark", "label": "Dark" },
        { "value": "auto", "label": "Auto" }
      ],
      "default": "light"
    },
    {
      "type": "url",
      "id": "api_url",
      "label": "API URL"
    },
    {
      "type": "range",
      "id": "margin",
      "label": "Margin (px)",
      "min": 0,
      "max": 50,
      "step": 5,
      "default": 20
    },
    {
      "type": "range",
      "id": "padding",
      "label": "Padding (px)",
      "min": 0,
      "max": 50,
      "step": 5,
      "default": 20
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color"
    },
    {
      "type": "checkbox",
      "id": "show_border",
      "label": "Show Border",
      "default": true
    },
    {
      "type": "color",
      "id": "border_color",
      "label": "Border Color",
      "default": "#e1e1e1"
    },
    {
      "type": "range",
      "id": "border_radius",
      "label": "Border Radius (px)",
      "min": 0,
      "max": 20,
      "step": 2,
      "default": 8
    }
  ]
}
{% endschema %}